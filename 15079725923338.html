
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>
    
  I don't understand Python's Asyncio - 七录书斋
  

  </title>
  <meta name="author" content="">
  <meta name="description" content="">

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link href="asset/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="atom.xml" rel="alternate" title="七录书斋" type="application/atom+xml">
  <script src="asset/js/modernizr-2.0.js"></script>
  <script src="asset/js/jquery.min.js"></script>
  <script src="asset/highlightjs/highlight.pack.js"></script>
  <link href="asset/highlightjs/styles/solarized_light.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script>hljs.initHighlightingOnLoad();</script>

  <style type="text/css">
  .cat-children-p{ padding: 6px 0px;}
  .hljs{background: none;}
  </style>
  <script type="text/javascript">
  var isAddSildbar = true;
  </script>
  <script src="asset/js/octopress.js" type="text/javascript"></script>
</head>
<script type="text/javascript">
//链接新开窗口
function addBlankTargetForLinks () {
  $('a[href^="http"]').each(function(){
      $(this).attr('target', '_blank');
  });
}
$(document).ready(function(event) {
  addBlankTargetForLinks();
});
</script>
<body   >
  <header role="banner"><hgroup>
  <h1><a href="index.html">七录书斋</a></h1>
  
    <h2></h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:forresthcang.com/wiki" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="index.html">Home</a></li>
  <li><a href="archives.html">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content"> 
<div>
	<article class="hentry" role="article">
	<header>
			  	<h1 class="entry-title">I don't understand Python's Asyncio</h1>
				<p class="meta"><time datetime="2017-10-14T17:16:32+08:00" pubdate data-updated="true">2017/10/14</time></p>
			 </header>
		  	<div class="entry-content">
			  	<p>笔记来源：<a href="https://linux.cn/article-8051-1.html">https://linux.cn/article-8051-1.html</a></p>

<h2 id="toc_0">原语</h2>

<p>asyncio 通过协程的帮助来实现异步 IO。最初它是通过 yield 和 yield from 表达式实现的一个库，因为 Python 语言本身演进的缘故，现在它已经变成了一个更复杂的怪兽。所以，为了在同一个频道讨论下去，你需要了解如下一些术语：</p>

<ul>
<li>事件循环: <a href="15079735695142.html">什么是 Event Loop？</a></li>
<li>时间循环策略</li>
<li>awaitable</li>
<li>协程函数</li>
<li>老式协程函数</li>
<li>协程</li>
<li>协程封装</li>
<li>生成器</li>
<li>future</li>
<li>并发的 future</li>
<li>任务</li>
<li>句柄</li>
<li>执行器（executor）</li>
<li>传输（transport）</li>
<li>协议</li>
</ul>

<p>此外，Python 还新增了一些新的特殊方法：</p>

<ul>
<li><code>__aenter__</code> 和 <code>__aexit__</code>，用于异步块的操作</li>
<li><code>__aiter__</code> 和 <code>__anext__</code>，用于异步迭代器（异步循环和异步推导）。为了更强大些，协议已经改变过一次了。在 Python 3.5 它返回一个 awaitable（这是个协程）；在 3.6 它返回一个新的异步生成器。</li>
<li><code>__await__</code>，用于自定义的 awaitable</li>
</ul>

<h2 id="toc_1">事件循环</h2>

<p>asyncio 事件循环和你第一眼看上去的略有不同。表面看，每个线程都有一个事件循环，然而事实并非如此。我认为它们应该按照如下的方式工作：</p>

<ul>
<li>如果是主线程，当调用 <code>asyncio.get_event_loop()</code> 时创建一个事件循环</li>
<li>如果是其他线程，当调用 <code>asyncio.get_event_loop()</code> 时返回运行时错误</li>
<li>当前线程可以使用 <code>asyncio.set_event_loop()</code> 在任何事件节点绑定事件循环。该事件循环可由 <code>asyncio.new_event_loop()</code> 函数创建</li>
<li>事件循环可以在不绑定到当前线程的情况下使用</li>
<li><code>asyncio.get_event_loop()</code> 返回绑定线程的事件循环，而非当前运行的事件循环</li>
</ul>

<p>这些行为的组合是很混淆的，主要有以下几个原因。首先，你需要知道这些函数被委托到全局设置的底层事件循环策略。默认是hi将事件循环绑定到线程。或者，如果需要的话，可以在理论上将事件循环绑定到一个 greenlet 或类似的。然而，重要是要知道库代码不控制策略，因此不能推断 asyncio 将适用于线程。</p>

<p>其次，asyncio 不需要通过策略将事件循环绑定到上下文。事件循环可以单独工作。但是这正是库代码的第一个问题，因为协同程序或类似的东西并不知道哪个事件循环负责调度它。这意味着，如果从协程中调用 <code>asyncio.get_event_loop()</code>，你可能没有机会取得事件循环。这也是所有 API 均采用可选的显式事件循环参数的原因。举例来说，要弄清楚当前哪个协程正在运行，不能使用如下调用：</p>

<pre><code class="language-python">def get_task():
    loop = asyncio.get_event_loop()
    try:
        return asyncio.Task.get_current(loop)
    except RuntimeError:
        return None
</code></pre>

<p>相反，必须显式地传递事件循环。这进一步要求你在库代码中显式地遍历事件循环，否则可能发生很奇怪的事情。</p>

<p>由于事件循环策略不提供当前上下文的标识符，因此库也不可能以任何方式「索引」到当前上下文。也没有回调函数用来监视这样的上下文拆除，这进一步限制了实际可以展开的操作。</p>

<h2 id="toc_2">Awaitables and Coroutines</h2>

<p>In my humble opinion the biggest design mistake of Python was to overload iterators so much. They are now being used not just for iteration but also for various types of coroutines. Python 中迭代器最大的设计错误之一是：如果 <code>StopIteration</code> 没有被捕获形成的空泡，这可能导致非常令人沮丧的问题，其中某处的异常可能导致其他地方的生成器或协同程序终止。这是一个长期存在的问题，基于 Python 的模板引擎 Jinja 经常面临这种问题。该模板引擎在内部渲染为生成器，并且当由于某种原因的模板引起 <code>StopIteration</code> 时，渲染就停止在那里。</p>

<p>Python 慢慢认识到了过度重载的教训。首先在 3.x 版本加入了 asyncio 模块，并没有语言级支持。所以自始至终它不过仅仅是装饰器和生成器而已。为了实现 yield from 以及其他东西。StopIteration 再次重载，这导致了令人困惑的行为，像这样：</p>

<p><img src="media/15079725923338/15079805254105.jpg" alt=""/></p>

<p>没有错误，没有警告，只是不是你期望的行为。这是因为从一个座位生成器的函数中 return 的值实际上引发了一个带有单个参数的 StopIteration，它不是由迭代器协议捕获的，而是在协程代码中处理。</p>

<p>在 3.5 和 3.6 有很多改变，因为现在除了生成器我们还有协程对象。除了通过封装生成器来生成协程，没有其他可以直接生成协程的单独对象。它是通过给函数加 <code>async</code> 前缀来实现。例如 <code>async def x()</code> 会产生这样的协程。在 3.6 中，将由单独的异步生成器，它通过触发 <code>AsyncStopIteration</code> 保持其独立性。此外，对于 Python 3.5 和更高的版本，导入新的 future 对象（generator_stop），如果代码在迭代步骤中触发 StopIteration，它将引发 RuntimeError。</p>

<p>老的实现方式并未真的消失。生成器仍然具有 <code>send</code> 和 <code>throw</code> 方法，以及协程仍然在很大程度上表现为生成器。</p>

<p>为了统一很多这样的重复，现在我们在 Python 中有更多的概念了：</p>

<ul>
<li>awaitable：具有 <code>__await__</code> 方法的对象。由本地协同程序和旧式协同程序以及一些其他程序来实现；</li>
<li>协程函数（coroutine function）：返回原生协程的函数。不要与返回协程的函数混淆；</li>
<li>协程（coroutine）：原生协程，注意，目前为止，当前文档不认为老式 asyncio 协程时协程程序。至少 insepect.iscoroutine 不认为它是协程。尽管它被 future/awaitable 分支接纳。</li>
</ul>

<h2 id="toc_3">协程封装器（coroutine wrapper）</h2>

<p>每当你运行 async def，Python 就会调用一个线程局部的协程封装器。它由 sys.set_coroutine_wrapper 设置，并且它是可以包装这些东西的一个函数。看起来有点像如下代码：</p>

<p><img src="media/15079725923338/15079813301626.jpg" alt=""/></p>

<p>在这种情况下，我从来没有实际调用原始的函数，只是给你一个提示，说明这个函数可以做些什么。目前我只能说它总是线程的局部有效，所以，如果替换事件循环策略，你需要搞清楚如何让协程封装器在相同的上下文同步更新。创建的新线程不会从父线程继承那些标识。</p>

<p>这不要与 asyncio 协程封装代码混淆。</p>

			</div>

		
	  
		<footer>
		 <p class="meta">

			<strong>Categories:</strong>&nbsp; 
			<span class="categories">
			
			    <a class='category' href='python.html'>Python</a>&nbsp;
			 
			</span>
		    </p>
		    <p class="meta">
		      
		 </p>
	    
		<div class="sharing">
			<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://tisogas-wiki.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
		</div>

	    <p class="meta">
	    
	        <a class="basic-alignment left" href="15079735695142.html" 
	        title="Previous Post: 什么是 Event Loop？">&laquo; 什么是 Event Loop？</a>
	    
	    
	        <a class="basic-alignment right" href="15078822029815.html" 
	        title="Next Post: 全栈必备：网络编程基础">全栈必备：网络编程基础 &raquo;</a>
	    
	    </p>
	  </footer>
	</article>
</div>
 <aside class="sidebar"> 

	<section>
	  <h1>Categories</h1>
	  <ul id="recent_posts">
	  
	      <li class="post">
	        <a href="programming.html"><strong>Programming&nbsp;(43)</strong></a>
	         <p class="cat-children-p"> 
	        
	        	<a href="python.html">Python&nbsp;(12)</a>&nbsp;&nbsp;
	        
	        	<a href="algorithms.html">Algorithms&nbsp;(2)</a>&nbsp;&nbsp;
	        
	        	<a href="swift.html">Swift&nbsp;(11)</a>&nbsp;&nbsp;
	        
	        	<a href="lisp.html">Lisp&nbsp;(3)</a>&nbsp;&nbsp;
	        
	        	<a href="javascript.html">JavaScript&nbsp;(1)</a>&nbsp;&nbsp;
	        
	        	<a href="network.html">Network&nbsp;(4)</a>&nbsp;&nbsp;
	        
	        	<a href="database.html">Database&nbsp;(4)</a>&nbsp;&nbsp;
	        
	        	<a href="web.html">Web 开发&nbsp;(1)</a>&nbsp;&nbsp;
	        
	         </p> 
	      </li>
	   
	  </ul>
	</section>
	<section>
	  <h1>Recent Posts</h1>
	  <ul id="recent_posts">
	  
	      
		      <li class="post">
		        <a href="15112591097718.html">Nginx 笔记</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15112590776263.html"></a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15107536000528.html">RPC Notes</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15088259624859.html">Flask 中的上下文</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15087352731978.html">常见的面试题整理 —— 数据库篇</a>
		      </li>
	     
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	  
	      
	   
	  </ul>
	</section>
	
</aside> </div></div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 -  -
  <span class="credit">Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a> &nbsp;&nbsp; Theme by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({TeX: { equationNumbers: { autoNumber: "AMS" } }});</script>

</body>
</html>